/*! @amzn/dtb-m.js - v2.50.0 - 2025-05-06 12:57:22 */!function(){"use strict";var e;!function(e){e.info="info",e.warn="warn",e.error="error"}(e||(e={}));class t{static Instance(){return this._instance}static SessionId(){return this._sessionId}info(...t){const n=new Date(Date.now()),r=e.info;return console.log(this.getPrefix(n,r),...t),{timestamp:n,logLevel:r}}warn(...t){const n=new Date(Date.now()),r=e.warn;return console.warn(this.getPrefix(n,r),...t),{timestamp:n,logLevel:r}}error(...t){const n=new Date(Date.now()),r=e.error;return console.error(this.getPrefix(n,r),...t),{timestamp:n,logLevel:r}}getPrefix(e,n){return`${e.toISOString()} | ${t.SessionId()} | [${n.toUpperCase()}]`}}t._instance=new t,t._sessionId=`${Date.now()}`;const n=t.Instance(),r="2.50.0",o="listeners",i="_internal/history",a="_config/events/deactivations",s="_internal/pageLoadID",d="_internal/externalEventCount",l="_internal/recentDispatches",c="_internal/coreDebugMode";function u(){try{return!!new URLSearchParams(window.top?.location.search??window.location.search).has("apscoredebug")||(window._aps?.get("_system").store.get(c)??!1)}catch{return!1}}class m{constructor(){this._batchSize=300,this._serviceUrl="https://prod.tahoe-analytics.publishers.advertising.a2z.com/logevent/putRecords",this._publicSourceIdentifier="79db72eb0b5c7255afa54a253df24fb4a5ac916bf40b51c730df8850aa5665ca",this._queueLimit=5e3,this._sampleRates=new Map([["error",0],["feat",0]]),this._recordQueues=new Map([["error",[]],["feat",[]]]),this.clearAndUpdateEventProcessingInterval(5e3)}logEvent({eventCategory:e,eventName:t,eventProperties:n,eventSource:r}){const o=`${Date.now()}`,i={eventSource:r??"aps_web_client_library",eventTime:o,eventCategory:e,eventName:t,eventProperties:{...n}};try{const e={Data:i,PartitionKey:o};this._recordQueues.get(i.eventCategory)?.push(e)}catch(e){}}setSampleRates(e){const t=e=>e<0?0:e>=0&&e<=1?e:1;"number"==typeof e?.error&&this._sampleRates.set("error",t(e.error)),"number"==typeof e?.feat&&this._sampleRates.set("feat",t(e.feat))}clearAndUpdateEventProcessingInterval(e){"number"!=typeof e||e<=0||e!==this._intervalDelayInMs&&(clearInterval(this._intervalId),this._intervalId=setInterval((()=>{try{this.processEventRecords()}catch(e){}}),e),this._intervalDelayInMs=e)}processEventRecords(){const e=[],t=Array.from(this._recordQueues.keys());for(let n=0;n<t.length;n+=1){const r=t[n],o=this._recordQueues.get(r),i=this._sampleRates.get(r);if(void 0===o||o.length<=0)continue;if(void 0===i||0===i){o.length>=this._queueLimit&&(o.length=0,this.logEvent({eventCategory:r,eventName:"queue limit reached"}));continue}const a=o.filter((e=>void 0!==e&&i>=Math.random()));o.length=0,e.push(...a)}if(0!==e.length)for(let t=0;t<e.length;t+=this._batchSize)this.sendRecords(e.slice(t,t+this._batchSize)).catch((e=>{}))}encodeRecords(e){return e.forEach((e=>{e.Data=window.btoa(JSON.stringify(e.Data))})),e}async sendRecords(e){await fetch(`${this._serviceUrl}?encoded=${u()?"false":"true"}`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this._publicSourceIdentifier},body:JSON.stringify({Records:u()?e:this.encodeRecords(e)})})}}const p={key:"_config/requestViewer/countryCode",default:"unknown"};const g=new class{constructor(){this.STACK_MAX_LENGTH=500,this._tahoeStream=new m}fireReferencePixel(e){Math.random()<.01&&this.logCoreError({id:`REFERENCE-${e}`,error:new Error(`REFERENCE-${e}`),account:null})}logCoreError(e){this.logError({...e,isCore:!0})}logCoreFeature(e){this.logFeature({...e,isCore:!0})}logError(e){void 0!==e&&this._tahoeStream.logEvent({eventCategory:"error",eventName:e.id??"unknown",eventSource:e.eventSource,eventProperties:{...e.props,...this.getSharedEventProperties(e),error:{name:this.getErrorName(e.error),message:this.getErrorMessage(e.error),stack:this.getStackTraceMessage(e.error),context:this.getErrorContext(e.error)}}})}logFeature(e){void 0!==e&&this._tahoeStream.logEvent({eventCategory:"feat",eventName:e.id??"unknown",eventProperties:{...e.props,...this.getSharedEventProperties(e),status:e.feature}})}setEventProcessingInterval(e){if("number"!=typeof e)throw new Error("Event processing interval must be a number.");this._tahoeStream.clearAndUpdateEventProcessingInterval(e)}setEventSamplingRates(e){"number"==typeof e?.error&&this._tahoeStream.setSampleRates({error:e.error}),"number"==typeof e?.feature&&this._tahoeStream.setSampleRates({feat:e.feature})}getSharedEventProperties(e){return{isCore:e.isCore??!1,accountID:this.safelyGetAccountID(e.account),libraryVersion:r,url:this.getLocationHref(),hostname:this.getLocationHostname(),viewerCountryCode:this.getViewerCountryCode(e.account)}}safelyGetAccountID(e){let t="unknown";try{void 0!==e?.id&&(t=e.id)}catch(e){try{t=`Client Error: ${e.name.toString()} - ${e.message}`}catch{t="Client Error: Unable to provide more information"}}return t}getLocationHref(){let e="";try{e=window.top?.location?.href??""}catch(t){try{e=`Client Error: ${t.name.toString()} - ${t.message}`}catch{e="Client Error: Unable to provide more information"}}return e}getLocationHostname(){let e="";try{e=window.top?.location?.hostname??""}catch(t){try{e=`Client Error: ${t.name.toString()} - ${t.message}`}catch{e="Client Error: Unable to provide more information"}}return e}getViewerCountryCode(e){let t="unknown";try{null!==e&&(t=e.use(p))}catch(e){try{t=`Client Error: ${e.name.toString()} - ${e.message}`}catch{t="Client Error: Unable to provide more information"}}return t}getStackTraceMessage(e){try{if("string"==typeof e)return"NO STACK: ERROR PASSED AS STRING";if(void 0===e.stack)return"NO STACK: error.stack IS UNDEFINED";if(e.stack.length>this.STACK_MAX_LENGTH){const t="[...]";return e.stack.substring(0,this.STACK_MAX_LENGTH-t.length)+t}return e.stack}catch(e){return"NO STACK: ERROR ON RETRIEVAL"}}getErrorName(e){let t="unknown";try{"string"==typeof e?t=e:void 0!==e.name&&(t=e.name)}catch(e){try{t=`Client Error: ${e.name.toString()} - ${e.message}`}catch{t="Client Error: Unable to provide more information"}}return t}getErrorMessage(e){let t="unknown";try{"string"==typeof e?t=e:void 0!==e.message&&(t=e.message)}catch(e){try{t=`Client Error: ${e.name.toString()} - ${e.message}`}catch{t="Client Error: Unable to provide more information"}}return t}getErrorContext(e){let t="unknown";try{"string"!=typeof e&&"context"in e&&(t=e.context??"")}catch(e){try{t=`Client Error: ${e.name.toString()} - ${e.message}`}catch{t="Client Error: Unable to provide more information"}}return t}};var h,b,f,v;!function(e){e.push="push",e.listenerSuccess="listenerSuccess",e.direct="direct"}(h||(h={})),function(e){e.internal="internal",e.apstag="apstag",e.webpage="webpage",e.dtbm="dtbm"}(b||(b={})),function(e){e.completed="completed",e.waiting="waiting",e.cancelled="cancelled"}(f||(f={})),function(e){e.started="started",e.error="error",e.unknown="unknown",e.deactivated="deactivated",e.analytics="analytics"}(v||(v={}));const w={...f,...v},y="debugSession/end",E="prepend/events",C="populator/ran",I={key:"consent/hasPurposeOneConsent",default:!1};class _{constructor(e){this.getItem=e=>{const t=this.globalContext.document.cookie.split("; ").reduce(((t,n)=>{const r=n.split("=");return r[0]===e?decodeURIComponent(r.slice(1).join("=")):t}),"");return t.length>0?t:null},this.removeItem=(e,t="/")=>{this.setItem(e,"",0,t)},this.setItem=(e,t,n,r="/")=>{const o=new Date(n);if(!this.isValidDate(o))throw new Error("Invalid expiration date");this.globalContext.document.cookie=`${e}=${t}; expires=${o.toUTCString()}; path=${r};`},this.globalContext=e}isValidDate(e){return e instanceof Date&&!isNaN(e)}}const A=["scope/objectName",y,E];function S(e){return null===e||"object"!=typeof e?e:e instanceof Date?new Date(e.getTime()):e instanceof Array?e.reduce(((e,t)=>(e.push(S(t)),e)),[]):e instanceof Set?Array.from(e.values()).reduce(((e,t)=>(e.add(S(t)),e)),new Set):e instanceof Map?Array.from(e.entries()).reduce(((e,t)=>(e.set(t[0],S(t[1])),e)),new Map):e instanceof Object?Object.keys(e).reduce(((t,n)=>(t[n]=S(e[n]),t)),{}):e}class x{constructor(e,t){const n=t.rootName;this.globalContext=t.globalContext;const r=this.globalContext[n].get(e);if(null==r)throw new Error(`Missing "${e}" account in userspace object`);this.id=e,this.store=r.store,this.queue=r.queue,this.store.has("listeners")||this.store.set("listeners",new Map)}async record(e,t){return await new Promise(((n,r)=>{this.queue.push(new CustomEvent(e,{detail:{resolve:n,reject:r,source:b.internal,...t}}))}))}async recordListener(e,t){return await new Promise(((n,r)=>{this.queue.push(new CustomEvent(e.name,{detail:{resolve:n,reject:r,source:b.internal,...t}}))}))}recordListenerNonBlocking(e,t){this.recordListener(e,t).catch((e=>{}))}read(e,t){const n=this.store.get(e);if(void 0!==n)return n;if(void 0!==t?.persist&&t.persist){const t=this.readLocalStorage(e,{usePrefix:!0});if(void 0!==t)return t}const r=t?.default?.generators?.get(e);return void 0!==r?r(...t?.default?.args??[]):void 0}write(e,t,n){this.store.set(e,t),void 0!==n?.persist&&n.persist&&this.writeLocalStorage(e,t,{usePrefix:!0})}use(e,t){let n;const r=this.store.get(e.key);if(void 0!==r)n=r;else if(void 0!==t?.persist&&t.persist){const t=this.readLocalStorage(e.key,{usePrefix:!0});null!=t&&(n=t)}const o=n??e.default;if("function"==typeof o||!1===t?.structuredClone)return o;try{return structuredClone(o)}catch(e){try{return S(o)}catch(e){return g.logCoreError({id:"Core.library.Account.use",account:null,error:e}),o}}}update(e,t,n){let r=t(this.use(e,n));if(void 0!==e.postProcessor&&(r=e.postProcessor(r)),this.store.set(e.key,r),void 0!==n?.persist&&n.persist){if("string"!=typeof r)throw new Error(`${JSON.stringify(r)} must be a string to be writtable to browser storage`);this.writeLocalStorage(e.key,r,{usePrefix:!0})}}delete(e,t){this.store.delete(e),void 0!==t?.persist&&t.persist&&this.deleteLocalStorage(e,{usePrefix:!0})}remove(e,t){this.store.delete(e.key),void 0!==t?.persist&&t.persist&&this.deleteLocalStorage(e.key,{usePrefix:!0})}executeFuncWithConsent(e,t){if(!this.isAllowedToAccessInfoOnDevice())throw new Error("Invalid consent. API requires consent before execution.");return t.apply(e)}recordErrorEvent(e){g.logError({...e,account:this})}recordStatusChangeEvent(e){g.logFeature({id:e.id,account:this,feature:e.status,props:{...e.props}})}recordGenericEvent(e){g.logFeature({id:e.id,account:this,feature:e.id,props:{...e.props}})}isAllowedToAccessInfoOnDevice(){return this.updateUserConsent(),this.use(I)}isAPStagAllowedToAccessInfoOnDevice(){return!0===this.globalContext.apstag._atsaaiod()}updateUserConsent(){try{const e=this.isAPStagAllowedToAccessInfoOnDevice();this.update(I,(()=>e))}catch(e){}}getPersistedItemName(e){return`aps:${this.id}:${e}`}isBrowserStorageAllowed(e){let t=!1;try{t=this.isAllowedToAccessInfoOnDevice()}catch{}return t||A.includes(e)}setCookieStorage(e,t,n,r){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be set on cookie storage`);const o=r?.usePrefix?this.getPersistedItemName(e):e;return new _(this.globalContext).setItem(o,t,n,r?.path??"/")}readCookieStorage(e,t){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be read from cookie storage`);const n=t?.usePrefix?this.getPersistedItemName(e):e;return new _(this.globalContext).getItem(n)}readLocalStorage(e,t){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be read from browser storage`);const n=t?.usePrefix?this.getPersistedItemName(e):e;if(n in this.globalContext.localStorage)return this.globalContext.localStorage.getItem(n)}writeLocalStorage(e,t,n){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be written to browser storage`);if("string"!=typeof t)throw new Error(`${JSON.stringify(t)} must be a string to be writtable to browser storage`);const r=n?.usePrefix?this.getPersistedItemName(e):e;this.globalContext.localStorage.setItem(r,t)}deleteLocalStorage(e,t){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be touched/deleted in browser storage`);const n=t?.usePrefix?this.getPersistedItemName(e):e;this.globalContext.localStorage.removeItem(n)}readSessionStorage(e,t){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be read from browser storage`);const n=t?.usePrefix?this.getPersistedItemName(e):e;if(n in this.globalContext.sessionStorage)return this.globalContext.sessionStorage.getItem(n)}writeSessionStorage(e,t,n){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be written to browser storage`);if("string"!=typeof t)throw new Error(`${JSON.stringify(t)} must be a string to be writable to browser storage`);const r=n?.usePrefix?this.getPersistedItemName(e):e;this.globalContext.sessionStorage.setItem(r,t)}deleteSessionStorage(e,t){if(!this.isBrowserStorageAllowed(e))throw new Error(`${e} is not allowed to be touched/deleted in browser storage`);const n=t?.usePrefix?this.getPersistedItemName(e):e;this.globalContext.sessionStorage.removeItem(n)}}const L="_system";class R extends x{constructor(e,t){super(L,{globalContext:e,rootName:t})}}class z{constructor(e,t,n){this.globalContext=e,this.rootName=t,this.dispatcher=n}getAccounts(){return this.globalContext[this.rootName]}createUserspaceRoot(){null==this.getAccounts()&&(this.globalContext[this.rootName]=new Map)}createSystemAccount(){if(!1===this.getAccounts().has(L)){this.getAccounts().set(L,{queue:[],store:new Map});new R(this.globalContext,this.rootName).store.set(s,Math.random())}}observeRootSet(){const e=this;this.getAccounts().set=function(t,n){Map.prototype.set.apply(this,[t,n]),e.equip()}}observeAccountQueuesPush(){const e=this;this.getAccounts().forEach((t=>{t.queue.push=function(...t){Array.prototype.push.apply(this,t),e.dispatcher._dispatch({reason:{method:h.push,events:t}})}}))}overwriteAccountStoresGet(){this.getAccounts().forEach((e=>{e.store.get=function(...e){return Map.prototype.get.apply(this,e)}}))}defineConvenienceFunctions(){const e=(e,t,n)=>{const r=this.getAccounts().get(e);void 0!==r&&r.queue.push(new CustomEvent(t,{detail:n??{}}))},t=this.globalContext[this.rootName];t.triggerFor=e,t.trigger=(t,n)=>{e(L,t,n)},void 0===t._private&&(t._private={}),t._private.CookieStorage=_}equip(){try{this.createUserspaceRoot(),this.createSystemAccount(),this.observeRootSet(),this.observeAccountQueuesPush(),this.overwriteAccountStoresGet(),this.defineConvenienceFunctions()}catch(e){throw new R(this.globalContext,this.rootName).recordErrorEvent({id:"Core.library.Equiper.equip",error:e}),e}}}const N=e=>{if(void 0===e||!Array.isArray(e))return!0;let t,n=window;do{if(e.includes(n?.location?.hostname))return!0;if(n===window.top)break;t=n,n=n.parent}while(t!==n&&t!==window.top);return!1},D={key:"_internal/eventSources",default:new Map},k={key:"_internal/processedEventSources",default:new Set},P=[w.completed,w.error,w.cancelled,w.analytics];class T{constructor(e,t){this.globalContext=e,this.rootName=t}_getDeactivations(e){return e.store.get(a)??new Set}_isEventDeactivated(e,t){return!0===this._getDeactivations(e).has(t.type)||((e,t)=>{try{const t=e.detail?.restrictions?.allow?.hostnames;if(void 0!==t&&!N(t))return!0;const n=e.detail?.restrictions?.block?.hostnames;if(void 0!==n&&N(n))return!0}catch(e){return t.recordErrorEvent({id:"hostnames",error:new Error(e)}),!1}return!1})(t,e)||(e=>{const t=e?.detail?.restrictions?.allow?.libraryVersions,n=e?.detail?.restrictions?.block?.libraryVersions;return!(!Array.isArray(n)||!n.includes(r))||!(!Array.isArray(t)||t.includes(r))})(t)||((e,t)=>{const n=e?.detail?.restrictions?.allow?.accounts,r=e?.detail?.restrictions?.block?.accounts;return!(!Array.isArray(r)||!r.includes(t.id))||!(!Array.isArray(n)||n.includes(t.id))})(t,e)}_getSystemListeners(){return new R(this.globalContext,this.rootName).store.get(o)??new Map}_getAccountListeners(e){return e.store.get("listeners")??new Map}_getListener(e,t){const n=this._getSystemListeners().get(t.type);return n||this._getAccountListeners(e).get(t.type)}_shouldWaitingEventBeProcessed(e){const t=this._readStoreItemCount(d);return(void 0===e.externalEventCount||e.externalEventCount<t)&&(e.externalEventCount=t,!0)}_shouldEventBeProcessed(e){if(void 0===e.status)return!0;if(e.status===w.started)return!1;if(P.includes(e.status))return!1;if(e.status===w.waiting)return!!this._shouldWaitingEventBeProcessed(e);if(e.status===w.unknown)return!1;if(e.status===w.deactivated)return!1;throw new Error(`Event status not explicitely handled: ${e.status}`)}_addTimeoutToPromiseRaceIfRequested(e,t){void 0!==t.detail?.timeout&&e.push(new Promise(((e,n)=>{setTimeout((()=>n(new Error(`Event "${t.type}" timed out`))),t.detail.timeout)})))}_incrementStoreItemCountBy(e,t){const n=new R(this.globalContext,this.rootName),r=n.read(e)??0;n.write(e,r+t)}_resetStoreItemCount(e){new R(this.globalContext,this.rootName).write(e,0)}_readStoreItemCount(e){return new R(this.globalContext,this.rootName).read(e)??0}_handleEventSuccess(e,t,r,o,i){if(!(t in w))throw new Error(`Listener returned invalid status: ${e.type} returned ${t}`);if(this._updateAndLogEventStatusOnChange(e,t,o,i),t!==w.waiting&&void 0!==e.detail?.resolve)try{e.detail.resolve(r)}catch(e){n.error(e)}this._dispatch({reason:{method:h.listenerSuccess,events:[e]}})}_handleEventFailure(e,t,n){void 0!==t&&"string"!=typeof t||(t=new Error(t)),this._updateAndLogEventStatusOnChange(e,w.error,n),this._surfaceErrorToExternalUsers(e,t),t.context=e.type,n.recordErrorEvent({id:e.type,error:t})}_addListenerToPromiseRace(e,t,n,r){const o=this._getListener(n,t);if(void 0===o)throw new Error(`No listener found for event: ${t.type}`);e.push(o({customEvent:t,account:n,systemAccount:r,detail:t.detail,context:n.globalContext}))}_runPromiseRace(e,t,n){Promise.race(e).then((e=>{let r,o,i;void 0===e?r=f.completed:"string"==typeof e?r=e:"object"==typeof e&&(r=e.status,o=e.value,i=e.analytics,!0===t.detail?.surfaceAnalytics&&(void 0===o&&(o={}),o.analytics=i)),this._handleEventSuccess(t,r,o,n,i)})).catch((e=>{this._handleEventFailure(t,e,n)}))}_executeListenerRace(e,t,n){const r=[];this._addListenerToPromiseRace(r,e,t,n),this._addTimeoutToPromiseRaceIfRequested(r,e),this._runPromiseRace(r,e,t)}_recordErrorPassedAsEventDetailIfNoStatus(e,t){if(void 0!==e.status)return;const n=e.detail?.error;if(void 0!==n){const r={id:e.type,error:n};"string"==typeof e.detail.source&&(r.eventSource=e.detail.source),t.recordErrorEvent(r)}}_recordAnalyticsPassedAsEventDetailIfNoStatus(e,t){if(void 0!==e.status)return;const n=e.detail?.analytics;void 0!==n&&(e.status=w.analytics,t.recordStatusChangeEvent({id:e.type,status:e.status,props:{...n}}))}_flagDeactivatedListener(e,t){this._isEventDeactivated(t,e)&&this._updateAndLogEventStatusOnChange(e,w.deactivated,t)}_flagMissingListenerIfNoStatus(e,t){if(void 0!==e.status)return;void 0===this._getListener(t,e)&&this._updateAndLogEventStatusOnChange(e,w.unknown,t)}_surfaceErrorToExternalUsers(e,t){if(void 0!==e.detail?.reject)try{e.detail.reject(t),u()&&n.error(t)}catch(e){n.error(e)}}_handleInvalidAccountError(e,t){const n=new Error(`Invalid account ID: "${t.id}"`);this._handleEventFailure(e,n,t)}static _isAccountValid(e){if("string"!=typeof e)return!1;return!["","undefined","true","false"].includes(e.trim())}_dispatchEvent(e,t,r){T._isAccountValid(t.id)?(this._recordErrorPassedAsEventDetailIfNoStatus(e,t),this._recordAnalyticsPassedAsEventDetailIfNoStatus(e,t),this._flagMissingListenerIfNoStatus(e,t),this._flagDeactivatedListener(e,t),this._shouldEventBeProcessed(e)&&(this._updateAndLogEventStatusOnChange(e,w.started,t),u()&&n.info(`## Execute event: ${e.type} with initial status ${e.status??"undefined"}`),this._executeListenerRace(e,t,r))):this._handleInvalidAccountError(e,t)}_prependEventsFromRegisteredSources(e){const t=new R(this.globalContext,this.rootName).use(D),n=e.use(k);t.forEach(((t,r)=>{if(n.has(r))return;const o=t.map((([e,t])=>new CustomEvent(e,{detail:t})));e.queue.unshift(...o),e.update(k,(e=>e.add(r)))}))}_dispatchAccount(e,t,n){this._prependEventsFromRegisteredSources(e),e.queue.forEach((n=>this._dispatchEvent(n,e,t)))}_updateEventStatus(e,t){e.status=t,e.statusEvents=null!=e.statusEvents?e.statusEvents:[],e.statusEvents.push(new CustomEvent(t))}_logEventUsage(e,t,n,r){const o=new CustomEvent("now").timeStamp,i=e.statusEvents?.find((e=>e.type===w.started)),a=null!=i?o-i.timeStamp:void 0;n.recordStatusChangeEvent({id:e.type,status:t,props:{...r,source:e.detail?.source,timers:{sinceCreated:o-e.timeStamp,sinceStarted:a}}})}_updateAndLogEventStatusOnChange(e,t,r,o){e.status!==t&&(u()&&n.info(`### Update ${e.type} from ${e.status??"undefined"} to ${t}`),this._updateEventStatus(e,t),this._logEventUsage(e,t,r,o))}_getAccounts(){const e=new Map;return this.globalContext[this.rootName].forEach(((t,n)=>e.set(n,new x(n,{globalContext:this.globalContext,rootName:this.rootName})))),e}_limitHistoryLength(e){if(u())return;const t=e.store.get(i)??[];if(t.length>150){const n=t.slice(-100);e.store.set(i,n)}}_recordProcessedEvents(e){const t=e.store.get(i)??[];t.push(...e.queue.filter((e=>void 0!==e.status&&P.includes(e.status)))),e.store.set(i,t)}_cleanUpAccountQueue(e){e.queue.splice(0,e.queue.length,...e.queue.filter((e=>void 0===e.status||!P.includes(e.status))))}_archive(){this._getAccounts().forEach((e=>{this._recordProcessedEvents(e),this._limitHistoryLength(e),this._cleanUpAccountQueue(e)}))}_filterExternalEvents(e){return e?.filter((e=>e.detail?.source!==b.internal&&e.detail?.source!==b.apstag&&e.status!==w.waiting))}_getNumberOfExternalEvents(e){const t=this._filterExternalEvents(e);return t?.length??0}_updateExternalEventCount(e){const t=this._getNumberOfExternalEvents(e);this._incrementStoreItemCountBy(d,t)}_throwOnInfiniteLoop(){const e=l;this._incrementStoreItemCountBy(e,1);const t=this._readStoreItemCount(e);if(t>1e4)throw new Error("Too many dispatches. Aborting");t%100==0&&new R(this.globalContext,this.rootName).recordGenericEvent({id:"C.l.D.thr",props:{recentDispatchesCount:t}}),setTimeout((()=>{this._resetStoreItemCount(e)}),100)}_dispatch({reason:e}){try{this._throwOnInfiniteLoop(),u()&&n.info(`# Dispatch from method "${e.method}" on event "${e.events?.[0].type??"undefined"}" with source "${e.events?.[0].detail?.source??"undefined"}"\n_________________________________________`),this._updateExternalEventCount(e.events);const t=new R(this.globalContext,this.rootName);this._getAccounts().forEach((n=>this._dispatchAccount(n,t,e))),this._archive()}catch(e){throw new R(this.globalContext,this.rootName).recordErrorEvent({id:"C.l.D.dis",error:e}),e}}}class ${constructor(e,t){this.globalContext=e,this.rootName=t}subscribe(e){try{const t=new R(this.globalContext,this.rootName),n=null!=t.store.get(o)?t.store.get(o):new Map;t.store.set(o,new Map([...n,...e]))}catch(e){throw new R(this.globalContext,this.rootName).recordErrorEvent({id:"Core.library.Subscriber.subscribe",error:e}),e}}}class M{constructor(e,t){this.globalContext=e,this.rootName=t}populate(){try{const e=new R(this.globalContext,this.rootName);let t=!1;try{t=JSON.parse(e.read(C))}catch{}if(t)return;e.write(C,JSON.stringify(!0)),this.populateFromPrependStore(),this.populateFromQueryParams()}catch(e){new R(this.globalContext,this.rootName).recordErrorEvent({id:"Core.library.Populator.populate",error:e})}}populateFromPrependStore(){this.globalContext[this.rootName].forEach(((e,t)=>{const n=new x(t,{globalContext:this.globalContext,rootName:this.rootName}),r=n.read(E,{persist:!0})??"[]";n.write(E,JSON.stringify([]));try{const e=JSON.parse(r);if(0===e.length)return;n.queue.push(...e.map(F))}catch(e){console.error("Error processing prepended events",e)}}))}populateFromQueryParams(){const e=this.globalContext?.location?.search,t=new URLSearchParams(e),n=this.globalContext[this.rootName],r=n.get(L);O(t,"aps.trigger").forEach((e=>{r.queue.push(F(e))}));O(t,"aps.triggerFor",!0).forEach((e=>{void 0!==e.accountId&&n.has(e.accountId)&&n.get(e.accountId).queue.push(F(e))}));const o=O(t,"aps_event");n.forEach((e=>{o.forEach((t=>{e.queue.push(F(t))}))}))}}const O=(e,t,n=!1)=>{const r=e.getAll(t),o=[];return r.forEach((e=>{const t=e.split(",");let r;n&&(r=t.shift());const i=t.shift();if(void 0!==i&&i.length>0){const e=decodeURIComponent(t.join(","));let n;if(e.length>0)try{n=JSON.parse(e)}catch{console.error("Error processing query param event",i,n)}o.push({eventName:i.replace(/_/g,"/"),eventDetail:n,accountId:r})}})),o},F=e=>new CustomEvent(e.eventName,{detail:{...e.eventDetail??{}}}),V=window,B="_aps";class U{constructor(e,t,n){this.ID=e,this.rootName=n,this.globalContext=t,this.clear()}clear(){new R(this.globalContext,this.rootName).update(D,(e=>(e.delete(this.ID),e)))}recordListener(e,t){new R(this.globalContext,this.rootName).update(D,(n=>{const r=n.get(this.ID);return void 0!==r?r.push([e.name,t]):n.set(this.ID,[[e.name,t]]),n}))}}class j{constructor(e=V,t=B){this.dispatcher=new T(e,t),this.equiper=new z(e,t,this.dispatcher),this.subscriber=new $(e,t),this.populator=new M(e,t),this.globalContext=e,this.rootName=t}createAccount(e){if(void 0===e)throw new Error("accountID must be provided");this.globalContext[this.rootName]=this.globalContext[this.rootName]??new Map;const t=this.globalContext[this.rootName],n={store:new Map,queue:[]};return!1===t.has(e)&&t.set(e,n),new x(e,{globalContext:this.globalContext,rootName:this.rootName})}subscribe(e){this.subscriber.subscribe(e)}equip(){this.equiper.equip()}dispatch({reason:e}){this.dispatcher._dispatch({reason:e})}populate(){this.populator.populate()}load({listeners:e}){this.equip(),this.subscribe(e),this.dispatch({reason:{method:h.direct}}),this.populate()}registerEventSource(e){return this.equip(),new U(e,this.globalContext,this.rootName)}}var H;!function(e){e.postulate="postulate",e.genericError="error"}(H||(H={}));const W="_aps_telemetry",q="alarms";function J(e,t){const n=()=>!1;!function(e,t,n){const r=window;void 0===r[W]&&(r[W]={});void 0===r[W][q]&&(r[W][q]=[]);const o=r[W][q],i=t.toString();o.push({hash:e,context:{...n,condition:i}})}(e,n,t);throw new Error(t?.message??`Postulate violation: ${e}, ${n}`)}const K=new WeakMap;function G(e,t,n="root",r="."){const o={nonModifiable:{set(e,t){throw new Error(`Cannot set property "${String(t)}": "${n}" is not marked as modifiable.`)},deleteProperty(e,t){throw new Error(`Cannot delete property "${String(t)}": "${n}" is not marked as modifiable.`)},defineProperty(e,t){throw new Error(`Cannot define property "${String(t)}": "${n}" is not marked as modifiable.`)},setPrototypeOf(e){throw new Error(`Cannot set prototype: "${n}" is not marked as modifiable.`)}},modifiable:{set(e,t,n,r){try{return Reflect.set(e,t,n,r)}catch(r){if("TypeError"===r.name)return e[t]=n,!0;throw r}}},validating:{get(e,o,i){if("__raw__"===o)return K.get(i)||e;if("symbol"==typeof o)return Reflect.get(e,o,i);if((e=>{if(["asymmetricMatch","nodeType"].includes(e))return!0})(o))return Reflect.get(e,o,i);let a;try{a=Reflect.get(e,o,i)}catch(t){if("TypeError"!==t.name)throw t;a=e[o]}return G(a,t,`${n}${r}${String(o)}`)},ownKeys:e=>Reflect.ownKeys(e).filter((e=>{const o=`${n}${r}${String(e)}`;return void 0!==t[o]}))},function:{apply:(e,r,o)=>{const i=K.has(r)?K.get(r):r;return G(e.apply(i,o),t,`${n}()`)},get:(e,t,n)=>"__raw__"===t?K.get(n)||e:Reflect.get(e,t,n)}};const i=function(r){if(!1===r.verifiable)return e;if(e instanceof Set)return e.forEach((e=>{G(e,t,`${n}.value`)})),e;if(e instanceof Map)return e.forEach(((e,r)=>{G(r,t,`${n}.key`),G(e,t,`${n}.value`)})),e;if(Array.isArray(e))return e.map((e=>G(e,t,`${n}[]`)));if("function"==typeof e){const t=new Proxy(e,o.function);return K.set(t,e),t}const i={...o.validating,...r?.modifiable?o.modifiable:o.nonModifiable};try{const t=new Proxy(e,i);return K.set(t,e),t}catch(t){if("TypeError"===t.name)return e;throw t}}(function(){const r=t[n];if(void 0===r&&J("HASH# A validator must be defined for any usage",{message:`Unauthorized usage for "${n}": No validator has been defined`}),null===r)return{verifiable:!1};let o;try{o=r(e,n)}catch(t){let r="Error, could not convert to string";try{r="string"==typeof e?'"'+e+'"':null!=e&&"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e)}catch(e){}throw new Error(`Validation failed for "${n}": ${t.message} - Received: ${r}`)}return o??{}}());return i}const Q=e=>{if("string"!=typeof e)throw new Error("must be a string")},Y=e=>{if("object"!=typeof e||null===e||Array.isArray(e))throw new Error("must be a standard object")},X=()=>{};class Z{constructor(e){const{scope:t,object:n,action:r,validators:o,handler:i}=e;this.throwIfInvalid(t,n,r),this.name=`${t}/${n}/${r}`,this.handler=this.wrapHandler(i,o)}wrapHandler(e,t){return async n=>{let r=n;return r={...r,detail:G(r.customEvent.detail,t?.detail??{detail:X},"detail"),context:G(r.account.globalContext,t?.context??{context:X},"context")},await e(r)}}throwIfInvalid(e,t,n){const r=/^[a-z0-9][a-zA-Z0-9]*$/;if(!r.test(e)||!r.test(t)||!r.test(n))throw new Error(`scope, object, and action must be alphanumeric and start with a lowercase. Received: ${e}, ${t}, ${n}`);if(/[A-Z]/.test(n)&&!/^(will|did)/i.test(n))throw new Error(`action must be a single verb (or a single verb prefixed by 'will' or 'did'). Received: ${n}`)}}const ee="amzn_skadn_start_imp";var te=new Z({scope:"maps",object:"impression",action:"willFire",handler:async({account:e,customEvent:t})=>{const n=t.detail;if(void 0===n)return{status:f.cancelled};const{bidId:r,skanEnabled:o}=n;return o&&oe(e,ee,{bidId:r}),{status:f.completed}}});const ne={key:"admob/history",default:{}},re=(e,t)=>`${e}/${t}`;function oe(e,t,n){if("object"!=typeof n)return!1;const r=e.use(ne)??{},o=n?.bidId??"unknown";return!(t===ie&&!r[re(o,ee)])&&(e.globalContext.admob.events.dispatchAppEvent(t,JSON.stringify(n)),r[re(o,t)]=!0,e.update(ne,(()=>r)),!0)}const ie="amzn_skadn_end_imp";var ae=new Z({scope:"maps",object:"ad",action:"willHide",handler:async({account:e,customEvent:t})=>{const n=t.detail;if(void 0===n)return{status:f.cancelled};const{bidId:r,skanEnabled:o}=n;return o&&oe(e,ie,{bidId:r}),{status:f.completed}}});function se(e){if("string"!=typeof e||"function"!=typeof e.replace)return e;const t=new RegExp("[^ ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=]","g");return e.replace(t,"")}function de(e){if("object"==typeof e&&null!==e)for(const t in e){if(!Object.prototype.hasOwnProperty.call(e,t))continue;const n=e[t];"object"==typeof n&&null!==n?de(n):"string"==typeof n&&(e[t]=se(n))}}function le(e){return async t=>{const n={...t};return delete n._type,de(n),await e.record(`dtbm-${t?._type??"undefined"}`,{analytics:n,source:b.dtbm}).catch((()=>{}))}}function ce(e,t){function n(e="cb"){return`${e}=${t.debugMode?0:Math.round(1e7*Math.random())}`}function r(e){let n=JSON.stringify((r=e,{lv:t.LIBRARY_VERSION,ts:t.debugMode?0:Date.now(),_tl:"aps-mtag",...r}));var r;return n=function(e){return e.replace(/\\.{1}/g,"")}(n),n=encodeURIComponent(n),n}function o(){return t.protocol+("aax.amazon-adsystem.com"===(e=t.aaxHost)?"aax-dtb-mobile-geo.amazon-adsystem.com":e)+"/x/px/";var e}function i(e){(new Image).src=e,t.debugState?.networkCalls.pixels.push(e),t.amzn.dtb.log(`Pixel sent: ${e}`)}function a(e){return o()+"p/PH/"+r(e)+"?"+n()}function s(e,t){return o()+t+"/"+r(e)+"?"+n()}return{sendClientAnalytics:le(e),send:function(e,t){try{let n;(t??"").length>0?(n=s(e,t),i(n)):(n=a(e),i(n))}catch(e){console?.log(e)}},getUrl:function(e,t){try{return(t??"").length>0?s(e,t):a(e)}catch(e){return console.log(e),null}}}}function ue(e,t,n,r={}){const o=JSON.stringify({...r});e.amzn.dtb.log(`${n} pixel evaluation: ${o}`),t.sendClientAnalytics({_type:n,...r??{}}),e.pixelTypes[n].currentlySampling&&(t.send({_type:n,...r},e.bidId),"iFrameSize"===r?.e?.et&&(e.iFrameSizeErrorPixelFired=!0),"iFrameSizeValid"===r?.e?.et&&(e.iFrameSizeValidPixelFired=!0))}async function me(e,t,n){try{if(t.hasCallAAXBTRBeenCalled)return;t.hasCallAAXBTRBeenCalled=!0;const r=encodeURIComponent(JSON.stringify({measurementMethod:"btr_client"})),o=`${t.protocol}${t.aaxHost}/x/px/${t.bidId??""}/btr/${r}`;if("function"==typeof e.fetch&&Math.random()<=.01&&await async function(e,t,n){return ue(e,t,"btr",{e:{et:"call-aax-btr-fetch"}}),await fetch(n).then((({status:n})=>(ue(e,t,"btr",{e:{et:"call-aax-btr-fetch-success",msg:n}}),!0))).catch((({status:n})=>(ue(e,t,"btr",{e:{et:"call-aax-btr-fetch-fail",msg:n}}),!1)))}(t,n,o))return;const i=new Image;i.onload=()=>{ue(t,n,"btr",{e:{et:"call-aax-btr-success"}})},i.onerror=e=>{let r;try{r=JSON.stringify(e)}catch(e){}ue(t,n,"btr",{e:{et:"btr-endpoint",msg:r}})},i.src=o,t.debugState?.networkCalls.pixels.push(o),t.amzn.dtb.log(`Pixel sent: ${o}`),ue(t,n,"btr",{e:{et:"call-aax-btr"}})}catch(e){let r="";try{r+=JSON.stringify(e)}catch(e){}ue(t,n,"btr",{e:{et:"call-aax-btr-fail",msg:r}})}}const pe={key:"endcard/config",default:void 0};function ge(e,t="cb"){return`${t}=${e?0:Math.round(1e7*Math.random())}`}function he(e){try{const t=parseInt(e,10);if(!isNaN(t)){if(t<=0)return!1;if(t>=100)return!0;if(100*Math.random()<=t)return!0}return!1}catch(e){return!1}}function be(e,t=null){for(const n in e.pixelTypes)Object.prototype.hasOwnProperty.call(e.pixelTypes,n)&&(e.pixelTypes[n].currentlySampling=he("number"==typeof t?t:e.pixelTypes[n].sampleRate))}function fe(e){return!(!e.apsAdIframe||!e.apsAdIframe.contentWindow)&&/\bmraid(?!.js)/.test(e.apsAdIframe.contentWindow.document?.body.innerHTML)}function ve(e,t){void 0!==e.mraidBridge?.service?.pushCommand&&null!==e.mraidBridge?.service?.pushCommand&&(t.amzn.dtb.log("Native bridge present, sending signal for impFired"),e.mraidBridge.service.pushCommand({type:"mraid",subtype:"impFired",arguments:{}}))}function we(e){return(e.MRAID_ENV?.sdk??"").length>0?e.MRAID_ENV.sdk:e.location.host}function ye(e,t,n){if(e.impPixelFired)return void e.amzn.dtb.log("Impression pixel already fired.");e.amzn.dtb.log("Firing impression on viewable event, with Pricepoint",e.selectedPricePoint,"and bidId:",e.bidId,`btr: ${String(e.isBTRCreative)}`);e.isBTRCreative&&ue(e,n,"btr",{e:{et:"btr-impression",msg:"BTR impression triggered"}}),e.btrPerformance.impressionTime=performance.now();const r=`${e.protocol}${e.aaxHost}/e/msdk/imp?b=${e.bidId??""}&ps=${e.selectedPricePoint??""}${(()=>{if(null===e.autoRefresh||"string"!=typeof e.autoRefresh)return"";const t={extraInfo:{isAutoRefreshed:e.autoRefresh.charAt(0).toUpperCase()+e.autoRefresh.slice(1)}};return`&pj=${encodeURIComponent(JSON.stringify(t))}`})()}&${ge(e.debugMode,"rnd")}`,o=new Image;o.onload=()=>function(e,t,n){if(t.isImpressionReady=!0,t.isBTRCreative)if(t.isBTRReady)me(e,t,n).catch((()=>{}));else try{const r=()=>null!=t.apsAdIframe?.contentWindow?.evaluateBTRCallback&&(t.apsAdIframe.contentWindow.evaluateBTRCallback((r=>{r&&me(e,t,n).catch((()=>{})),t.btrPerformance.btrCbTime=performance.now(),t.btrPerformance.sendPixel(r),ue(t,n,"btr",{e:{et:"btr-trigger",msg:"fireImpression"}})})),!0);let o=0;const i=()=>{r()||(o>5e3?ue(t,n,"btr",{e:{et:"btr-interval",msg:"evaluateBTRCallback undefined"}}):(setTimeout(i,o),o=0===o?30:1.5*o))};i()}catch(e){let r="Generic BTR error";try{r+=JSON.stringify(e)}catch(e){}ue(t,n,"btr",{e:{et:"btr-generic-error",msg:r}})}}(t.globalContext,e,n),o.src=r,e.debugState?.networkCalls.imp.push(r),e.impPixelFired=!0,function(e,t,n=[]){Object.keys(e.eventListeners).includes(t)?e.eventListeners[t].forEach((e=>{try{e(...n)}catch(e){console.error(e)}})):e.amzn.dtb.log(`${t} is not a valid event`,"checkEventListeners")}(e,"impression",[]),ve(t.globalContext,e),ue(e,n,"adRendering",{adrendering:we(t.globalContext),mediatype:"display"}),t.record(we(t.globalContext).includes("aps")?"maps/displayAdTriggeredByFirstParty/willRender":"maps/displayAdTriggeredByThirdParty/willRender").catch((()=>{})),e.skAdNetwork&&ue(e,n,"skAdNetworkMraid",{mraidfound:fe(e)}),t.recordListener(te,{bidId:e.bidId,skanEnabled:e.skAdNetwork}).catch((()=>{}))}function Ee(e,t){const n=`{"adViewability":[{"error": {"m": "${t}"}}], "c": "viewability", "api": "MAPP", "error": 1}`,r=`${e.protocol}${e.aaxHost}/x/px/${e.bidId??""}/${n}?cb=${Math.round(1e7*Math.random())}`;(new Image).src=r,e.debugState?.networkCalls.pixels.push(r)}function Ce(e,t,n){!function(e,t,n){(t.listenerForMeasureIFrameListener??[]).forEach((t=>e.globalContext.removeEventListener("resize",t)));const r=function(e,t,n,r=!0){const o=e.getComputedStyle(t.apsAdIframe),i=parseInt(o.width,10),a=parseInt(o.height,10);let s=!0;t.amzn.dtb.log(`iFrame measured at ${i}x${a}`),i<300||a<50?(s=!1,r&&(t.amzn.dtb.log("Firing iFrameSize error pixel"),t.iFrameSizeErrorPixelFired||ue(t,n,"apsLibraryError",{e:{et:"iFrameSize",msg:`${i}x${a}`}}))):t.iFrameSizeErrorPixelFired&&!t.iFrameSizeValidPixelFired&&r&&(t.amzn.dtb.log("Firing iFrameSizeValid pixel"),n.send({_type:"iFrameSizeValid",size:`${i}x${a}`},t.bidId));return s}(e.globalContext,t,n,!t.isBTRCreative);if(t.isInterstitial){if(r)return void ye(t,e,n);t.listenerForMeasureIFrameListener=t.listenerForMeasureIFrameListener??[];const o=Ce.bind(null,e,t,n);return t.listenerForMeasureIFrameListener.push(o),void e.globalContext.addEventListener("resize",o)}if(!r){t.listenerForMeasureIFrameListener=t.listenerForMeasureIFrameListener??[];const r=Ce.bind(null,e,t,n);t.listenerForMeasureIFrameListener.push(r),e.globalContext.addEventListener("resize",r)}ye(t,e,n)}(e,t,n)}function Ie(e,t,n){if(e.globalContext.mraid?.isViewable()){t.listenerForMeasureIFrameListener=t.listenerForMeasureIFrameListener??[];const r=Ce.bind(null,e,t,n);t.listenerForMeasureIFrameListener.push(r),e.globalContext.addEventListener("resize",r),Ce(e,t,n)}else e.recordListener(ae,{bidId:t.bidId,skanEnabled:t.skAdNetwork}).catch((()=>{}))}function _e(e){e.innerHTML="",e.style.width="",e.style.height=""}function Ae(e,t,n){t.apsAdIframe=e.document.createElement("iframe"),t.apsAdIframe.style.border="none",t.apsAdIframe.style.overflow="hidden",t.apsAdIframe.setAttribute("border","0"),t.apsAdIframe.setAttribute("id",t.apsiFrameId),t.apsAdIframe.sandbox="allow-forms allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation",n.appendChild(t.apsAdIframe)}function Se(e,t){t.amzn.dtb.log("Adding window resizing event to detect window size"),t.inspectWindowSizeForIframeListener=t.inspectWindowSizeForIframeListener??[];const n=Te.bind(null,e,t);t.inspectWindowSizeForIframeListener.push(n),e.addEventListener("resize",n),Te(e,t)}function xe(e){return null!=e.amzn_bridge?e.amzn_bridge:null!=e.webkit?.messageHandlers?.amzn_bridge?e.webkit.messageHandlers.amzn_bridge:null}const Le=function(e,t,n){const r=e.mraid?.open;this.sdkVersion="mDTB-js-1.0.1",this.os="Android",t.isIOS&&(this.os="iOS"),"unknown"===t.amzn.dtb.sdkType&&(location.href.includes("mopub")?t.amzn.dtb.sdkType="mopub":location.href.includes("doubleclick")&&(t.amzn.dtb.sdkType="dfp")),(e.mraid??{}).open=function(o,i){if(t.skAdNetwork&&t.isIOS){t.amzn.dtb.log("SKAdNetwork flag enforced, mraid.open will dispatch click now to APS SDK");const r={bidId:t.bidId,destinationUrl:o};if(e.admob?.events&&"function"==typeof e.admob.events.dispatchAppEvent)return e.admob.events.dispatchAppEvent("amzn_skadn",JSON.stringify(r)),void t.amzn.dtb.log("dispatch click to APS SDK successful");t.amzn.dtb.log("problem detecting bridge, proceeding without dispatch to APS SDK"),ue(t,n,"apsLibraryError",{e:{et:"dispatchAppEvent",msg:"not present"}})}if("string"==typeof o){if(t.amzn.dtb.log("Original URL:",o),/^amazonmobile:\/\//g.test(o)){const e=o.split("intent=");if(e.length>1){const r="https://dl.amazon.com/redirect/ref=mm_1_aps-mobile-dl?campaignId=QALXjR&failureMode=MobileWebMostly&url=",i=e[e.length-1],a=decodeURIComponent(i);(function(e){if("string"!=typeof e)return!1;const t=e.match(/^(?:\w+:)?\/\/(\S+)$/);if(null==t)return!1;const n=t[1];return void 0!==n&&""!==n&&null!==n&&!(!/^localhost[:?\d]*(?:[^:?\d]\S*)?$/.test(n)&&!/^[^\s.]+\.\S{2,}$/.test(n))})(a)||ue(t,n,"apsLibraryError",{e:{et:"validateDLFallbackURL",msg:a}}),o=`${r}${i}`,ue(t,n,"deepLink")}}t.amzn.dtb.log("Opening URL:",o),/^http/g.test(o)&&"mopub"===t.amzn.dtb.sdkType?(t.amzn.dtb.log("Opening url using mopub native interface."),r.apply(e.mraid,["mopubnativebrowser://navigate?url="+encodeURIComponent(o)])):(t.amzn.dtb.log("Opening url using mraid interface."),r.apply(e.mraid,[o,i]))}},this.openUrl=e.mraid?.open};function Re(e,t,n){if(void 0===t.apsAdIframe)return;t.apsAdIframe.contentWindow.mraid=e.mraid,t.apsAdIframe.contentWindow.amazon={},t.apsAdIframe.contentWindow.dtb=new Le(e,t,n),t.apsAdIframe.contentWindow.amzn={dtb:{impressionPixelFired:t.amzn.dtb.impressionPixelFired,isOmidPresent:()=>"object"==typeof e.omid&&null!==e.omid,addEventListener:t.amzn.dtb.addEventListener,removeEventListener:t.amzn.dtb.removeEventListener}};const r=xe(e);null!=r&&t.isVideo&&(t.apsAdIframe.contentWindow.apsVidEventsBridge=r)}function ze(e,t,n){try{const r=xe(e);return null!=r&&"function"==typeof r.postMessage&&(r.postMessage(t.isAndroid?JSON.stringify(n):n),!0)}catch(e){return!1}}function Ne(e,{hide:t=!1,adsManager:n,endCardsEnabled:r}={}){const o=e.use(pe);if(!0!==r||"function"!=typeof n?.triggerEndCardFlow||t)e.globalContext.mraid?.useCustomClose(t);else try{n.triggerEndCardFlow(o)}catch(n){e.globalContext.mraid?.useCustomClose(t)}}function De(e,t,n,r,o,i,a){const{globalContext:s}=e,d="string"==typeof(l=t.videoType)&&l.toLowerCase().includes("rewarded");var l;const c=d||t.videoSkipAfter||0===t.videoSkipAfter,u=null!==c&&(!0===c||c>=0);let m=!1;u&&Ne(e,{hide:!0,adsManager:null,endCardsEnabled:u});const p=r.document.createElement("style");p.innerHTML="body { margin: 0px; padding: 0px }",r.document.head.appendChild(p);const g=r.document.createElement("script");g.src=o,r.document.body.appendChild(g);const h=r.document.createElement("div");h.style="height: 100%; width: 100%; position: absolute;",h.setAttribute("id","amazon-ads-container"),r.document.body.appendChild(h),g.addEventListener("load",(()=>{const o=new r.AmazonVideoAds(h,Fe(s,t,{bidInfo:i,endCardsEnabled:u})),l=a&&t.staticCreativeURL?t.staticCreativeURL:`https://${i.vastHost}/${i.dataCenter}/e/msdk/vast?b=${i.bidId}&${ge(t.debugMode,"rnd")}&ps=${i.selectedPricePoint}`;t.debugState?.networkCalls?.adm&&(t.debugState.networkCalls.adm.push(l),t.amzn.dtb.log("videoPlayProps",JSON.stringify(Fe(s,t,{bidInfo:i,endCardsEnabled:u}))));const p=e=>{const{eventName:n}=e;if(!n||""===n)return void t.amzn.dtb.log(`Invalid apsvid eventName: ${n}`);const o={type:"apsvid",subtype:n,arguments:{}};r.apsVidEventsBridge&&(t.amzn.dtb.log(`Bridging apsVideoPlayerSDK event ${n} to native: ${JSON.stringify(o)}`),r.apsVidEventsBridge.postMessage(t.isAndroid?JSON.stringify(o):o))};p({eventName:"AD_DEBUG_FETCH_START"}),o.fetchAdsFromUrl(l).then((o=>{p({eventName:"AD_DEBUG_FETCH_FIRST_DONE"}),o.init({fullscreen:!0,muted:!d,volume:.3,autoplay:!1,controls:!1,preload:"auto",replayEnabled:!1}),o.onPlayerReadyListener((()=>{let i=!1;const a=()=>{r.mraid.isViewable()&&!i&&(r.mraid.removeEventListener("viewableChange",a),i=!0,o.play(),setTimeout((()=>{c&&!m&&(t.amzn.dtb.log("countDownAppended is false, using fallback to show close button"),Ne(e,{hide:!1,adsManager:o,endCardsEnabled:u}),ue(t,n,"apsLibraryError",{e:{et:"countDownAppended",msg:"playVideoHandler"}}))}),5e3))};r.mraid.addEventListener("viewableChange",a),a();r.mraid.addEventListener("viewableChange",(()=>{r.mraid.isViewable()||o.mute(!0)}));const s=(e,n)=>{const r=d?n:t.videoSkipAfter;return Math.ceil(r-e)},l=e=>{const{adMetadata:{creative:{progress:n,duration:o}}}=e,i=s(n,o);if(r.document.getElementById("aps-countdown")||i<=0&&!c)return;t.amzn.dtb.log("Appending countdown element");const a=r.document.createElement("div");a.setAttribute("id","aps-countdown"),a.style="\n            width: 12px;\n            height: 12px;\n            padding: 10px;\n            border-radius: 50%;\n            position: absolute;\n            z-index: 1000;\n            top: 15;\n            right: 15;\n            font: bold 20px Arial, sans-serif;\n            color: white;\n            background-color: rgba(231, 231, 231, 0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n          ",a.innerText=d?o:t.videoSkipAfter,r.document.body.appendChild(a),m=!0},g={AD_VIDEO_PLAYER_STARTED:c?l:null,AD_VIDEO_PLAYER_IMPRESSION:()=>{t.amzn.dtb.log("Impression event received from apsVideoPlayerSDK, posting message"),r.top.postMessage({apsVideoPlayer:!0,event:"impression"},r.top.location.origin)},AD_VIDEO_PLAYER_PROGRESS:c?i=>{const{adMetadata:{creative:{progress:a,duration:d}}}=i,c=s(a,d),m=r.document.getElementById("aps-countdown");if(!m&&c>0)return t.amzn.dtb.log("updateCountdownElement: element not present, using fallback"),l(i),void ue(t,n,"apsLibraryError",{e:{et:"countDownAppended",msg:"updateCountdownElement"}});m&&(c>0&&m.innerText!==c.toString()?(t.amzn.dtb.log("Updating countdown element"),m.innerText=c):c<=0&&(t.amzn.dtb.log("Removing countdown element"),m.parentNode.removeChild(m),t.amzn.dtb.log("Sending request to native for showing close button"),Ne(e,{hide:!1,adsManager:o,endCardsEnabled:u})))}:null,AD_VIDEO_PLAYER_COMPLETED:n=>{const i=r.document.getElementById("aps-countdown");i&&(t.amzn.dtb.log("Removing countdown element via AD_VIDEO_PLAYER_COMPLETED fallback"),i.parentNode.removeChild(i),t.amzn.dtb.log("Sending request to native for showing close button"),Ne(e,{hide:!1,adsManager:o,endCardsEnabled:u})),p(n)},AD_VIDEO_PLAYER_CLICKED:p,AD_VIDEO_END_CARD_CLOSE_CLICKED:()=>{p({eventName:"END_CARD_VIDEO_CLOSED"})},AD_VIDEO_END_CARD_RENDERED:()=>{p({eventName:"END_CARD_COMPANION_AD_START"})},AD_VIDEO_END_CARD_COMPANION_AD_CLICKED:()=>{p({eventName:"END_CARD_COMPANION_AD_CLICKED"})},AD_VIDEO_END_CARD_COMPANION_AD_CLOSED:()=>{p({eventName:"END_CARD_COMPANION_AD_CLOSED"})},AD_VIDEO_DEFAULT_END_CARD_START:()=>{p({eventName:"DEFAULT_END_CARD_START"})},AD_VIDEO_DEFAULT_END_CARD_CLICKED:()=>{p({eventName:"DEFAULT_END_CARD_CLICKED"})}};Object.keys(g).forEach((e=>{g[e]&&o.addListener(e,g[e])}))})),o.startAds(2e3,{shouldVideoRemainAfterPlay:!0})})).then((()=>p({eventName:"AD_LOADED"}))).catch((o=>{p({eventName:"AD_FAILED_TO_LOAD"}),t.amzn.dtb.log("An error occurred with APSVideoPlayerSDK",o);const i=r.document.getElementById("aps-countdown");i&&i.parentNode.removeChild(i),t.amzn.dtb.log("Sending request to native for showing close button"),Ne(e,{hide:!1,adsManager:null,endCardsEnabled:u}),ue(t,n,"apsLibraryError",{e:{et:"fetchVASTUrlError",msg:{host:t.vastHost,dc:t.dataCenter,pp:t.selectedPricePoint}}})}))}))}function ke(e,t){const n=e.innerWidth,r=e.innerHeight;void 0!==t.apsAdIframe&&(t.apsAdIframe.style.width=`${n}px`,t.apsAdIframe.style.height=`${r}px`),t.amzn.dtb.log(`apsAdIframe size assigned to ${n}x${r}`),t.isInterstitial||function(e,t){if(t.amzn.dtb.log(`Inspecting for interstitial with window size of ${e.innerWidth}x${e.innerHeight}`),e.innerWidth>=320&&e.innerHeight>250){t.amzn.dtb.log("Interstitial threshold window area detected"),t.isInterstitial=!0,t.amzn.dtb.log("Interstitial - removing iFrame resize event to assign width/height"),t.inspectWindowSizeForIframeListener=t.inspectWindowSizeForIframeListener??[],t.inspectWindowSizeForIframeListener.forEach((t=>e.removeEventListener("resize",t))),t.amzn.dtb.log("Interstitial - adding MRAID viewableChange event listener"),t.assignViewableInterstitialDimensionsListener=t.assignViewableInterstitialDimensionsListener??[];const n=r.bind(null,e,t);t.assignViewableInterstitialDimensionsListener.push(n),e.mraid?.addEventListener("viewableChange",n),e.mraid?.isViewable()&&!t.interstitialDimensionsAssigned&&r(e,t)}let n=!1;function r(e,t){if(e.mraid?.isViewable()){t.interstitialDimensionsAssigned=!0,t.amzn.dtb.log("Interstitial - MRAID isViewable is true"),t.amzn.dtb.log("Interstitial - removing MRAID viewableChange event listener"),(t.assignViewableInterstitialDimensionsListener??[]).forEach((t=>e.mraid?.removeEventListener("viewableChange",t))),t.amzn.dtb.log("Interstitial - assigning intersitial dimensions on viewable"),void 0!==t.apsAdIframe&&(t.apsAdIframe.style.width="100vw",t.apsAdIframe.style.height="100vh"),t.checkInterstitialForNotchDeviceListener=t.checkInterstitialForNotchDeviceListener??[];const r=o.bind(null,e,t);t.checkInterstitialForNotchDeviceListener.push(r),e.addEventListener("resize",r),e.setTimeout((()=>{n||(t.amzn.dtb.log("Interstitial - notch detection fallback running for resize not firing"),o(e,t))}),100)}}function o(e,t){if(n=!0,(t.checkInterstitialForNotchDeviceListener??[]).forEach((t=>e.removeEventListener("resize",t))),function(e,t){let n=!1;const r=e.document.createElement("div");CSS.supports("padding-top: env(safe-area-inset-top)")?(r.style.paddingTop=t.isUnitTests?"200pt":"env(safe-area-inset-top)",r.style.paddingBottom=t.isUnitTests?"100pt":"env(safe-area-inset-bottom)",r.style.paddingLeft=t.isUnitTests?"50pt":"env(safe-area-inset-left)",r.style.paddingRight=t.isUnitTests?"40pt":"env(safe-area-inset-right)",n=!0):CSS.supports("padding-top: constant(safe-area-inset-top)")&&(r.style.paddingTop=t.isUnitTests?"200pt":"constant(safe-area-inset-top)",r.style.paddingBottom=t.isUnitTests?"100pt":"constant(safe-area-inset-bottom)",r.style.paddingLeft=t.isUnitTests?"50pt":"constant(safe-area-inset-left)",r.style.paddingRight=t.isUnitTests?"40pt":"constant(safe-area-inset-right)",n=!0);if(n){e.document.body.appendChild(r);const t={top:parseInt(e.getComputedStyle(r).paddingTop,10),bottom:parseInt(e.getComputedStyle(r).paddingBottom,10),left:parseInt(e.getComputedStyle(r).paddingLeft,10),right:parseInt(e.getComputedStyle(r).paddingRight,10)};e.document.body.removeChild(r);for(const e in t)if(t[e]>0)return!0}return!1}(e,t))return t.amzn.dtb.log("Interstitial - notch detected"),void i(e,t);if(t.isAndroid){t.amzn.dtb.log("Interstitial - adding resize event for Android to use pixels"),t.inspectWindowSizeForIframeListener=t.inspectWindowSizeForIframeListener??[];const n=Te.bind(null,e,t);t.inspectWindowSizeForIframeListener.push(n),e.addEventListener("resize",n)}t.amzn.dtb.log("Interstitial - no notch detected")}function i(e,t){void 0!==t.apsAdIframe&&(t.apsAdIframe.style.position="absolute",t.apsAdIframe.style.top="50%",t.apsAdIframe.style.left="50%",t.apsAdIframe.style.transform="translate(-50%, -50%)");let n=e.innerHeight>e.innerWidth?"portrait":"landscape";t.amzn.dtb.log("Interstitial - applying sizes for notch");let r=!1,o=!1;if(t.isIOS&&Ve(e)){t.amzn.dtb.log(`gmaSDK detected: ${e.MRAID_ENV.sdkVersion}`);const n=e.MRAID_ENV.sdkVersion.split(".").map((e=>parseInt(e,10))),i={major:n[0],minor:n[1],patch:n[2]};(7===i.major&&i.minor>=46||i.major>7)&&(r=!0,t.amzn.dtb.log("Interstitial - disabling iOS 13 logic for notch")),(7===i.major&&i.minor>=49||i.major>7)&&(o=!0,t.amzn.dtb.log("Interstitial - using window.orientation value for device rotation"))}function i(i){const a=10;let s=0,d=!1;function l(c){if(t.amzn.dtb.log(`Interstitial - value of window.orientation is ${e.orientation}`),!0===i&&!0!==c)t.amzn.dtb.log(`Interstitial - initializing notch dimensions: ${n}`);else{if(o){const r=n;n=0===e.orientation||-180===e.orientation?"portrait":"landscape",r!==n&&(d=!0,t.amzn.dtb.log("Interstitial - window.orientation value has changed, ending polling"))}else n="portrait"===n?"landscape":"portrait";t.amzn.dtb.log(`Interstitial - notch orientation change: ${n}`)}"portrait"===n?void 0!==t.apsAdIframe&&(t.apsAdIframe.style.width="100vw",t.apsAdIframe.style.height=Me(e,t)&&!r?"100vh":Me(e,t)&&r?"87vh":"90vh"):void 0!==t.apsAdIframe&&(t.apsAdIframe.style.width=Me(e,t)&&r?"87vw":"90vw",t.apsAdIframe.style.height="100vh"),s++,s!==a?!0!==i&&o&&!d&&s<a&&e.setTimeout((()=>{t.amzn.dtb.log(`Interstitial - loopCount for checking orientation is ${s}`),l(!0)}),100):t.amzn.dtb.log("Interstitial - ending polling, max loops reached")}l(!1)}i(!0),e.addEventListener("orientationchange",i)}}(e,t)}async function Pe(e,t,n,r=0){if(n===t.windowCheckId){const o={apsAdIframe:{calculatedWidth:parseInt(t?.apsAdIframe?.style.width,10),calculatedHeight:parseInt(t?.apsAdIframe?.style.height,10)},window:{calculatedWidth:e.innerWidth,calculatedHeight:e.innerHeight}};t.amzn.dtb.log(`Inspecting apsAdIframe ${o.apsAdIframe.calculatedWidth}x${o.apsAdIframe.calculatedHeight} vs window ${o.window.calculatedWidth}x${o.window.calculatedHeight} | retry count ${r}`),o.apsAdIframe.calculatedWidth===o.window.calculatedWidth&&o.apsAdIframe.calculatedHeight===o.window.calculatedHeight||(t.amzn.dtb?.log("Change detected in window size, forcing resize event"),function(e){const t=e.document.createEvent("UIEvents");t.initUIEvent("resize",!0,!1,e,0),e.dispatchEvent(t)}(e)),r<5?(t.amzn.dtb.log(`Delaying next window size detection by ${t.pollingTimeouts[r]}ms`),await(async e=>await new Promise((n=>setTimeout(n,t.pollingTimeouts[e]))))(r),Pe(e,t,n,r+1)):t.amzn.dtb.log("inspectWindowPoll try count exceeded, killing inspectWindowPoll instance")}else t.amzn.dtb.log("tryId mismatch with windowCheckId, killing inspectWindowPoll instance")}function Te(e,t){t.amzn.dtb.log("Entering a new instance of inspectWindowSizeForIframe"),ke(e,t),t.windowCheckId=Date.now(),Pe(e,t,t.windowCheckId)}function $e(e){e.amzn.dtb.log("Adjusting anchor links to _top");const t=e.apsAdIframe?.getElementsByTagName("a")??[];for(let e=0;e<t.length;e++){const n=t[e];null==n.onclick&&0===(n.target??"").length&&(n.target="_top")}}function Me(e,t){if(t.isIOS){const t=e.navigator.userAgent.match(/OS [0-9]+/g);if(null!=t){return parseInt(t[0].match(/[0-9]+/g)[0],10)>=13}return!1}return!1}function Oe(e){return e||null}function Fe(e,t,n){const r=e.MRAID_ENV,o={source:"mobile",publisherType:"mobile",publisherAppId:Oe(r.appId),endCardsEnabled:n.endCardsEnabled,integratorVersion:t.LIBRARY_VERSION,mobileSDKVersion:Oe(r.sdkVersion),bidId:n.bidInfo.bidId,hostName:n.bidInfo.vastHost,pricePoint:n.bidInfo.selectedPricePoint,adServerType:we(e)};return r.mobileDeviceInfo&&(o.mobileDeviceType=Oe(r.mobileDeviceInfo.model),o.mobileDevicePlatform=`${Oe(r.mobileDeviceInfo.os)}-${Oe(r.mobileDeviceInfo.fwk)}`,o.mobileDeviceOSVersion=Oe(r.mobileDeviceInfo.osVersion)),o}function Ve(e){return"3.0"===e.mraid?.getVersion()&&"Google Mobile Ads"===e.MRAID_ENV?.sdk&&(e.MRAID_ENV?.sdkVersion??"").length>0}var Be=new Z({scope:"maps",object:"itunesInfo",action:"fetch",validators:{detail:{detail:Y,"detail.itunesId":Q,"detail.countryCode":Q},context:{context:Y}},handler:async({detail:e,account:t})=>{const{itunesId:n,countryCode:r}=e,o=`https://itunes.apple.com/lookup?id=${n}&country=${r}`,i=await t.globalContext.fetch(o);if(!i.ok)throw new Error(`Error fetching iTunes app info (${o}): ${i.status} ${i.statusText}`);const a=await i.json();if(!(a?.results?.length>0&&a?.results[0]))throw new Error("Warning: No app found for given iTunes ID: "+n+" - Country: "+r);const{trackName:s,artworkUrl100:d,trackViewUrl:l}=a.results[0];return t.update(pe,(()=>({default:{name:s,imageUrl:d,buttonText:"GET",trackViewUrl:l,isShowOverlay:!0}}))),{status:f.completed}}}),Ue=new Z({scope:"maps",object:"ad",action:"load",handler:async({account:e,customEvent:t})=>{const n=t.detail;if(void 0===n)return{status:f.cancelled};const{dtbGlobal:r,pixel:o,pricePoint:i,suppliedBidId:a,hostName:s,debugOn:d,options:l}=n,{skadn:c,isv:u,dc:m,cURL:p,ebtr:g,skipafter:h,vtype:b}=l??{};d&&(r.amzn.dtb.toggleDebug("enable"),r.amzn.dtb.log("Enabling debug mode, now all logs will be printed & http will used for connection."));const v=[{argName:"pricePoint",type:"string",value:i},{argName:"suppliedBidId",type:"string",value:a},{argName:"hostName",type:"string",value:s},{argName:"debugOn",type:"boolean",value:d},{argName:"isv",type:"boolean",value:u},{argName:"dc",type:"string",value:m},{argName:"cURL",type:"string",value:p},{argName:"ebtr",type:"boolean",value:g},{argName:"skipafter",type:"number",value:h},{argName:"vtype",type:"string",value:b}].reduce(((e,t)=>{const{argName:n,type:r,value:o}=t;return typeof o===r&&null!==o&&""!==o||(e[n]={type:r,passed:typeof o,value:o}),e}),{});if(r.skAdNetwork=!1,r.skAdNetworkInfo=null,r.isIOS)if("true"===c||!0===c)r.skAdNetwork=!0;else if("object"==typeof c&&(c?.itunesitem?.length??0)>0&&(r.skAdNetworkInfo=c,r.skAdNetwork=!0,r.skAdNetworkInfo?.itunesitem))try{await e.recordListener(Be,{itunesId:r.skAdNetworkInfo.itunesitem,countryCode:"US"})}catch(e){}void 0===v.suppliedBidId&&(r.amzn.dtb.log(`Setting bidId: ${a}`),r.bidId=a),void 0!==v.hostName||s.includes("BAD")||(r.amzn.dtb.log(`Overriding default aaxHost with: ${s}`),r.aaxHost=s),void 0===v.isv&&(r.amzn.dtb.log(`Setting isVideo: ${String(u)}`),r.isVideo=u),void 0===v.dc&&(r.amzn.dtb.log(`Setting dc: ${String(m)}`),r.dataCenter=m),void 0===v.cURL&&(r.amzn.dtb.log(`Setting cURL: ${String(p)}`),r.staticCreativeURL=p),void 0===v.ebtr&&(r.amzn.dtb.log(`Setting overrideBTRValue: ${String(g)}`),r.overrideBTRValue=g),void 0===v.skipafter?(r.amzn.dtb.log(`Setting videoSkipAfter: ${String(h)}`),r.videoSkipAfter=h):(r.amzn.dtb.log("Invalid skipafter passed, defaulting skipafter to 5 seconds"),r.videoSkipAfter=5),void 0===v.vtype&&(r.amzn.dtb.log(`Setting vtype: ${String(b??"")}`),r.videoType=b);const w=Object.keys(v).filter((e=>null!==v[e].value));if(w.length>0&&(w.forEach((e=>{r.amzn.dtb.log(`Invalid argument passed to loadAd for "${e}". Passed type: ${v[e].passed} | correct type: ${v[e].type} | value: ${v[e].value}`)})),ue(r,o,"apsLibraryError",{e:{et:"loadAdArgs",msg:w}})),"object"==typeof v.suppliedBidId||"object"==typeof v.pricePoint)return r.amzn.dtb.log("Error","Crucial arguments incorrectly passed, aborting"),{status:f.cancelled};if(r.amzn.dtb.log(`Setting pricepoint: ${i}`),r.selectedPricePoint=i,r.skAdNetwork&&r.isIOS&&(Ve(e.globalContext)||location.href.includes("doubleclick"))){r.amzn.dtb.log('SKAdNetwork flag passed as "true", requesting google_mobile_app_ads.js');const t=e.globalContext.document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://media.admob.com/api/v1/google_mobile_app_ads.js",e.globalContext.document.body.appendChild(t),r.debugState?.networkCalls.lib.push(t.src)}r.amzn.dtb.log("Creating viewport meta tag and adding it to head.");const y=e.globalContext.document.createElement("meta");var E;if(y.name="viewport",y.content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover",e.globalContext.document.head.appendChild(y),function(e,t,n){let r=["getVersion","isViewable","addEventListener","removeEventListener"];r=void 0===t.mraid||"object"!=typeof t.mraid||null===t.mraid?["mraid"].concat(r):r.filter((e=>"function"!=typeof t.mraid?.[e])),r.length>0&&ue(e,n,"apsLibraryError",{e:{et:"missingMraidMethods",msg:r}})}(r,e.globalContext,o),(E=e.globalContext).apsOmsdkLogs=[],E.addEventListener("message",(e=>{Object.prototype.hasOwnProperty.call(e?.data,"apsOmsdkLog")&&E.apsOmsdkLogs.push(e.data.apsOmsdkLog)})),r.isVideo&&(r.dataCenter??"").length>0)return function(e,t,n){const{globalContext:r}=e,o=r.document.getElementById(t.adDivId);o?(_e(o),Ae(r,t,o),Se(r,t),Re(r,t,n),r.addEventListener("message",(o=>{o.data.apsVideoPlayer&&"impression"===o.data.event&&(t.amzn.dtb.log("Video impression occurred, attemping to bridge to native for impFired"),t.debugState?.networkCalls.imp.push("videoImpFired"),ve(r,t),ue(t,n,"adRendering",{adrendering:we(r),mediaType:"video"}),e.record(we(r).includes("aps")?"maps/videoAdTriggeredByFirstParty/willRender":"maps/videoAdTriggeredByThirdParty/willRender").catch((()=>{})))})),t.apsAdIframe.contentWindow.apsVidCreate=De,t.apsAdIframe.contentWindow.apsVidCreate(e,t,n,t.apsAdIframe?.contentWindow,t.debugMode?t.apsVidLocation.beta:t.apsVidLocation.prod,{vastHost:t.vastHost,dataCenter:t.dataCenter,bidId:t.bidId,selectedPricePoint:t.selectedPricePoint},t.debugMode),$e(t)):t.amzn.dtb.log('Ad div not found. Please place an empty div with id="__dtbAd__" in the page, aborting!')}(e,r,o),{status:f.completed};if(r.debugMode&&(r.staticCreativeURL??"").length>0)return async function(e,t){try{const n=await fetch(t),r=await n.text();e.amzn.dtb.renderAd({html:r})}catch(e){console.log("Error retrieving static display creative",e)}}(r,r.staticCreativeURL),{status:f.completed};r.amzn.dtb.log("Making JSONP call to load the creative.");const C=e.globalContext.document.createElement("script");return C.type="text/javascript",C.src=`${r.protocol}${r.aaxHost}/e/msdk/adm?b=${r.bidId}&ps=${r.selectedPricePoint}`,C.onerror=()=>{ze(e.globalContext,r,{type:"aps",subtype:"onAdFailedToLoad",arguments:{}})},e.globalContext.document.body.appendChild(C),r.debugState?.networkCalls.adm.push(C.src),{status:f.completed}}}),je=new Z({scope:"maps",object:"ad",action:"render",handler:async({account:e,customEvent:t})=>{const n=t.detail;if(void 0===n)return{status:f.cancelled};const{dtbGlobal:r,pixel:o,nikeTest:i}=n;r.amzn.dtb.ev=n.ev;const a=(n?.html??"").length>0;if(ze(e.globalContext,r,{type:"aps",subtype:a?"onAdLoaded":"onAdFailedToLoad",arguments:{}}),!a)return r.amzn.dtb.log("Looks like there is no creative in JSONP call, aborting!"),{status:f.cancelled};const s=e.globalContext.document.getElementById(r.adDivId);if(null==s)return r.amzn.dtb.log('Ad div not found. Please place an empty div with id="__dtbAd__" in the page, aborting!'),{status:f.cancelled};_e(s),Ae(e.globalContext,r,s),Se(e.globalContext,r),Re(e.globalContext,r,o);const d=r?.apsAdIframe?.contentDocument??(r?.apsAdIframe?.contentWindow).document,l=function(e,t){const n=t.indexOf("mraid.js");return-1!==n&&(e.amzn.dtb.log("Purging extra mraid.js from the creative."),t=t.substring(0,n)+t.substring(n+8),e.amzn.dtb.log("New Creative: ",t)),t}(r,n.html),c=`<style> body { margin: 0px; padding: 0px } </style>${l}`;null!==r.overrideBTRValue&&(n.ebtr=r.overrideBTRValue),void 0!==n.ebtr&&null!==n.ebtr&&""!==n.ebtr&&(r.isBTRCreative=!0,function(e,t,n){e.addEventListener("message",(r=>{!0===r.data?.cremFailed&&ue(t,n,"btr",{e:{et:"crem-failed"}}),"object"==typeof r.data&&(Object.prototype.hasOwnProperty.call(r.data,"btr")&&"boolean"==typeof r.data.btr||Object.prototype.hasOwnProperty.call(r.data,"cremLoaded"))&&(void 0!==r.data.btr&&null!==r.data.btr&&!1!==r.data.btr&&(t.isBTRReady=!0,ue(t,n,"btr",{e:{et:"btr-trigger",msg:"addBTRMessageListener btr"}}),t.isImpressionReady&&(me(e,t,n).catch((()=>{})),ue(t,n,"btr",{e:{et:"btr-crem-rare-scenario-2"}}))),!0===r.data.cremLoaded&&null!=t.apsAdIframe?.contentWindow?.evaluateBTRCallback&&t.apsAdIframe.contentWindow.evaluateBTRCallback((r=>{r&&(t.isBTRReady=!0,t.isImpressionReady&&(me(e,t,n).catch((()=>{})),ue(t,n,"btr",{e:{et:"btr-crem-rare-scenario"}}))),t.btrPerformance.btrCbTime=performance.now(),t.btrPerformance.sendPixel(r),ue(t,n,"btr",{e:{et:"btr-trigger",msg:"addBTRMessageListener cremLoaded"}})})))}))}(e.globalContext,r,o));return"autoRefresh"in n&&(r.autoRefresh=n.autoRefresh),d.open("text/html"),d.write(r.isBTRCreative?function(e,t){return e.amzn.dtb.log("Adding BTR script to creative"),t+"\n    <script\n      src='https://m.media-amazon.com/images/I/11gqnnPRWRL.js'\n      onload=\"window.parent.postMessage({ cremLoaded: true }, '*')\"\n      onerror=\"window.parent.postMessage({ cremFailed: true }, '*')\"\n    ><\/script>\n    <script>\n      window.evaluateBTRCallback = function(cb) {\n        window.CREM.evaluateBTRCriteria(document, document, function(result) {\n          console.log('isBTRCompliant', result.isBTRCompliant);\n          window.parent.postMessage({ btr: result.isBTRCompliant }, '*');\n\n          if (typeof cb === 'function') {\n            cb({ isBTRCompliant: result.isBTRCompliant });\n          }\n        });\n      }\n\n      function readyStateListener() {\n        if (document.readyState === 'complete') {\n          window.evaluateBTRCallback();\n          document.removeEventListener('readystatechange', readyStateListener);\n        }\n      }\n      if (document.readyState === 'complete') {\n        window.evaluateBTRCallback();\n      } else {\n        document.addEventListener('readystatechange', readyStateListener);\n      }\n    <\/script>"}(r,c):c),d.close(),$e(r),"mraid"in e.globalContext?(function(e,t){e.amzn.dtb.log("Registering impression rendered event, with Pricepoint",e.selectedPricePoint,"and bidId:",e.bidId),t.impRendered()}(r,i),r.isBTRCreative&&(r.btrPerformance.addViewableCalledTime=performance.now(),"complete"===d.readyState?r.btrPerformance.adFinishedLoadingTime=performance.now():e.globalContext.addEventListener("message",(e=>{!0===e.data.cremLoaded&&(r.btrPerformance.adFinishedLoadingTime=performance.now())}))),function(e,t,n){t.viewableChangeListener=t.viewableChangeListener??[];const r=Ie.bind(null,e,t,n);t.viewableChangeListener.push(r),e.globalContext.mraid?.addEventListener("viewableChange",r),Ie(e,t,n)}(e,r,o),function(e,t){if(!0===e.amzn.dtb.ev){e.amzn.dtb.log("Injecting viewability script");const n=t.document.createElement("script");n.type="text/javascript",n.async=!0,n.onload=function(){if(e.amzn.dtb.log("Viewability script loaded"),"function"==typeof t.amzncsm?.rmRM){let n;const r=t.document.getElementById(e.adDivId);if(null!=r){const e=r.getElementsByTagName("iframe");e?.length>0&&(n=e[0])}t.amzncsm.host=e.aaxHost,null!=n?t.amzncsm.rmRM(e.bidId,n):Ee(e,"ad iframe not found")}else Ee(e,"amzncsm.rmRM is not a function")},n.onerror=function(){Ee(e,"CSM JS loading failed")},n.src=e.CSM_JS,t.document.body.appendChild(n),e.debugState?.networkCalls.lib.push(e.CSM_JS),e.amzn.dtb.log("Viewability script injected")}}(r,e.globalContext),i.mraid3Comparison(),Ve(e.globalContext)&&ue(r,o,"gmaSDK",{gmaversion:e.globalContext.MRAID_ENV.sdkVersion}),{status:f.completed}):(r.amzn.dtb.log("Error","Mraid object not found, impression will not be made."),r.amzn.dtb.log('Please include \'<script type="text/javascript" src="mraid.js"><\/script>\' in your creative.'),{status:f.cancelled})}}),He=new Z({scope:"maps",object:"library",action:"initialize",handler:async({account:e,customEvent:t})=>{e.globalContext.amzn=e.globalContext.amzn??{},e.globalContext.amzn.dtb=e.globalContext.amzn.dtb??{},e.globalContext.amzn.dtb.sdkType="unknown";const n={amzn:e.globalContext.amzn,debugMode:!1,isUnitTests:!1,aaxHost:"aax-us-east.amazon-adsystem.com",vastHost:"c.amazon-adsystem.com",bidId:null,selectedPricePoint:null,isVideo:!1,dataCenter:null,staticCreativeURL:null,isBTRCreative:!1,isBTRReady:!1,isImpressionReady:!1,overrideBTRValue:null,videoSkipAfter:null,videoType:null,hasCallAAXBTRBeenCalled:!1,autoRefresh:null,protocol:"https://",adDivId:"__dtbAd__",apsiFrameId:"apsAdIframe",LIBRARY_VERSION:"2.50.0",isAndroid:/linux.*android.*?/g.test(e.globalContext.navigator.userAgent.toLowerCase()),isIOS:/(iphone|ipod|ipad|mac).*applewebkit.*?/g.test(e.globalContext.navigator.userAgent.toLowerCase()),interstitialDimensionsAssigned:!1,isInterstitial:!1,apsAdIframe:void 0,skAdNetwork:!1,windowCheckId:null,pollingTimeouts:[100,400,500,1500,2500],apsVidLocation:{prod:"https://video-player.aps.amazon-adsystem.com/apsvid.js",beta:"https://beta-video-player.aps.amazon-adsystem.com/apsvid.js"},CSM_JS:"https://c.amazon-adsystem.com/bao-csm/mobile/csm.js.gz",pixelTypes:{nike:{sampleRate:1,currentlySampling:!1},apsLibraryError:{sampleRate:5,currentlySampling:!1},gmaSDK:{sampleRate:1,currentlySampling:!1},deepLink:{sampleRate:1,currentlySampling:!1},adRendering:{sampleRate:1,currentlySampling:!1},skAdNetworkMraid:{sampleRate:1,currentlySampling:!1},btr:{sampleRate:1,currentlySampling:!1}},impPixelFired:!1,iFrameSizeErrorPixelFired:!1,iFrameSizeValidPixelFired:!1,eventListeners:{impression:[]},btrPerformance:{adFinishedLoadingTime:0,btrCbTime:0,addViewableCalledTime:0,impressionTime:0,sendPixel:function(e){try{ue(n,o,"btr",{e:{et:"btr-performance",msg:JSON.stringify({AFLT:Math.round(this.adFinishedLoadingTime),BCBT:Math.round(this.btrCbTime),AVCT:Math.round(this.addViewableCalledTime),IT:Math.round(this.impressionTime),IBC:e})}})}catch(e){}}}};n.debugState={networkCalls:{pixels:[],adm:[],imp:[],lib:[]},logs:[],eventListeners:n.eventListeners},n.amzn.dtb.log=function(){const e=Array.from(arguments).join(" ");n.debugMode&&!n.isUnitTests&&console?.log(e),n.debugState?.logs.push(e)},be(n);const r=function(){let t=!1;const r=function(){if(e.globalContext.mraid.isViewable()&&!t){const i=a(2);o.send(i,n.bidId),t=!0,e.globalContext.mraid?.removeEventListener("viewableChange",r)}},i=function(t){if(t>=1){const t=a(3);o.send(t,n.bidId),e.globalContext.mraid?.removeEventListener("exposureChange",i)}};function a(e){return{p:e,_type:"nike"}}return{impRendered:function(){const e=a(1);o.send(e,n.bidId)},mraid3Comparison:function(){n.pixelTypes.nike.currentlySampling&&"3.0"===e.globalContext.mraid.getVersion()&&(e.globalContext.mraid.addEventListener("viewableChange",r),e.globalContext.mraid.addEventListener("exposureChange",i),r())}}}(),o=ce(e,n);return n.amzn.dtb.dispatchAppEvent=function(t,r,i,a,s){if("fb"===a)try{e.globalContext.admob.events.dispatchAppEvent("mDTB","facebook")}catch(e){ue(n,o,"apsLibraryError",{e:{et:"mdtb-ad-rendering",msg:"admob/fb"}})}else n.amzn.dtb.loadAd(t,r,i,s)},n.amzn.dtb.toggleDebug=function(t,r=100){switch(t){case"enable":return n.debugMode=!0,void 0===e.globalContext.amznDebugState&&(e.globalContext.amznDebugState=n.debugState),be(n,r),n.amzn.dtb.log("Debug mode enabled");case"disable":return n.debugMode=!1,void 0!==e.globalContext.amznDebugState&&delete e.globalContext.amznDebugState,be(n),n.amzn.dtb.log("Debug mode disabled");case"unitTests":return n.isUnitTests=!0,n.amzn.dtb.log("Disabling dtbGlobal.amzn.dtb.log console logs showing in unit tests");default:return n.amzn.dtb.log("unknown debug argument")}},n.amzn.dtb.loadAd=function(t,r,i,a=!1,s={skadn:null,isv:!1,dc:null,cURL:null,ebtr:null,skipafter:5,vtype:null}){e.recordListener(Ue,{dtbGlobal:n,pixel:o,pricePoint:t,suppliedBidId:r,hostName:i,debugOn:a,options:s}).catch((()=>{}))},n.amzn.dtb.addEventListener=function(e,t){Array.isArray(n.eventListeners[e])?"function"==typeof t?n.eventListeners[e].push(t):n.amzn.dtb.log("Function was not provided for event listener","addEventListener"):n.amzn.dtb.log(`${e} is not a valid event`,"addEventListener")},n.amzn.dtb.impressionPixelFired=function(){return n.impPixelFired},n.amzn.dtb.removeEventListener=function(e,t){Array.isArray(n.eventListeners[e])&&(n.eventListeners[e]=void 0!==t?n.eventListeners[e].filter((e=>e!==t)):[])},n.amzn.dtb.renderAd=function(t){e.recordListener(je,{...t,dtbGlobal:n,pixel:o,nikeTest:r}).catch((()=>{}))},e.globalContext.toTest={nikeTest:r,isMinimumiOS13:function(){if(n.isIOS){const t=e.globalContext.navigator.userAgent.match(/OS [0-9]+/g);if(null!=t){return parseInt(t[0].match(/[0-9]+/g)[0],10)>=13}return!1}return!1}},e.globalContext.aax_render_ad=n.amzn.dtb.renderAd,{status:f.completed}}});const We=function(e){if(new Set(e.map((e=>e.name))).size!==e.length)throw new Error("Duplicates found");return new Map(e.map((e=>[e.name,e.handler])))}([Ue,je,He,ae,te,Be]);const qe=new Map([["analytics/sampling/set",async({account:e,customEvent:t})=>void 0===t?.detail?.rates?f.cancelled:(void 0!==t?.detail?.rates?.error&&g.setEventSamplingRates({error:t.detail.rates.error}),void 0!==t?.detail?.rates?.status&&g.setEventSamplingRates({feature:t.detail.rates.status}),f.completed)],["log/analytics/setSampling",async()=>{throw new Error("log/analytics/setSampling has been deprecated. Will be removed after 3/1/2024.")}],["log/analytics/setInterval",async({account:e,customEvent:t})=>{if("number"!=typeof t.detail?.interval)throw new Error("Invalid 'interval' param passed");return g.setEventProcessingInterval(t.detail.interval),f.completed}],["log/library/didError",async()=>{throw new Error("log/library/didError has been deprecated. Will be removed after 3/1/2024.")}],["log/library/didUseFeature",async()=>{throw new Error("log/library/didUseFeature has been deprecated. Will be removed after 3/1/2024.")}]]),Je="dtb-m";try{g.setEventSamplingRates({error:.001,feature:1e-4}),g.fireReferencePixel(Je);const e=new Map([...qe,...We]),t=window?.MRAID_ENV?.appId,n=T._isAccountValid(t)?t:"n/a",r=new j;r.load({listeners:e});r.createAccount(n).recordListener(He).catch((()=>{}))}catch(e){g.logCoreError({id:Je,error:e,account:null}),u()&&n.error(e)}}();
//# sourceMappingURL=dtb-m.js.map

